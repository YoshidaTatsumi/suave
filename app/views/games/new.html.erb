<div class="row">
	<h2>ゲーム投稿</h2>
</div>

<div class="row">
	<% if @game.errors.any? %>
		<h2><%= @game.errors.count %>
			 errors prohibited this obj from being saved:
		</h2>
		<ul>
			<% @game.errors.full_messages.each do |message| %>
				<li><%= message %></li>
			<% end %>
		</ul>
	<% end %>
</div>

<%= form_for(@game) do |f| %>
	<h3>スクリーンショット選択</h3>
	<div class="row">
		<%= f.nested_fields_for :screenshots, wrapper_tag: :div do |i| %>
			<div class="col-xs-3" style="margin-top: 20px;">
				<%= image_tag "NoImage.jpg", alt:"Screenshot preview", class: "center-block image_prev", size: "250x140" %><br>
	        	<%= i.label :image, "画像を変更", class:"btn btn-info" %>
				<%= i.attachment_field :image, onchange: "previewFile(this)", style:"display: none;" %>
				<%= i.remove_nested_fields_link "削除", class: "btn btn-danger" %>
			</div>
    	<% end %>
    </div>
	<div class="row">
		<%= f.add_nested_fields_link :screenshots, '画像を追加する', class: "btn btn-primary", style:"margin-top: 40px;"%>
	</div>

	<div class="row">
		<div class="col-xs-12">
			<div class="row field">
				<%= f.label :title, "タイトル" %>（<span class="required">※必須</span>）<br>
				<%= f.text_field :title, size:"80x1" %>
			</div>

			<div class="row field">
				<%= f.label :url, "ダウンロードURL" %>（<span class="required">※必須</span>）<br>
				<%= f.text_area :url, size:"80x2" %>
			</div>

			<div class="row field">
				<%= f.label :tag_list, 'タグをカンマ区切りで入力' %><br>
				<%= text_field_tag 'game[tag_list]', @game.tag_list, data: {role: "tagsinput"} %>
			</div>
		</div>
    </div>

    <div class="row field">
		<%= f.label :introduction, "ゲームについて" %>（<span class="required">※必須</span>）<br>
		<%= f.text_area :introduction, data: { provider: 'summernote'} %>
	</div>


	<div class="row" style="margin-top: 40px;">
		<%= f.submit "アップロード", class:"col-xs-4 col-xs-offset-4 btn btn-primary" %>
	</div>

<% end %>

<script>
	//Summernoteの設定
	$(function () {
	    $('[data-provider="summernote"]').each(function(){
	    	$(this).summernote({
	    		lang: 'ja-JP',
	        	height: 400,
	        	toolbar: [
	        		['fontsize', ['fontsize']],
	        		['fontname', ['fontname']],
	          		['style', ['style']],
			        ['font', ['bold', 'underline', 'clear']],
			        ['color', ['forecolor', 'backcolor']],
			        ['para', ['ul', 'ol', 'paragraph']],
			        ['table', ['table']],
			        ['insert', ['link', 'picture', 'table', 'hr']],
			        ['view', ['undo', 'redo', 'fullscreen', 'codeview', 'help']]
	        	]
	      	});
	    })
	})

	//画像を８枚まで投稿できるようにする
	$(function() {
	  var fieldsCount,
	      maxFieldsCount = 6,
	      $addLink = $('a.add_nested_fields_link');

	  function toggleAddLink() {
	    $addLink.toggle(fieldsCount <= maxFieldsCount)
	  }

	  $(document).on('fields_adding.nested_form_fields', function() {
	    fieldsCount += 1;
	    toggleAddLink();
	  });

	  $(document).on('fields_removing.nested_form_fields', function() {
	    fieldsCount -= 1;
	    toggleAddLink();
	  });

	  fieldsCount = $('form .fields').length;
	  toggleAddLink();
	})

	//画像プレビュー
	function previewFile(obj) {
		var preview = $(".image_prev")[obj.name[29]];
		var file    = obj.files[0];
		var reader  = new FileReader();

		if (file) {
			reader.readAsDataURL(file);
		}

		reader.addEventListener("load", function () {
	    	preview.src = reader.result;
		}, false);
	}
</script>